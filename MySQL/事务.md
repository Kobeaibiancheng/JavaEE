# 事务

事务是一组操作的集合，它是一个不可分割的工作单位，事务会把所有的操作作为一个整体一起向系统提交或撤销操作请求，即**这些操作要么同时成功，要么同时失败**。

## 事务的操作

1.MySQL的SQL语句是默认自动提交事务，autocommit = 1 表示默认提交事务

当设置为手动提交事务时（autocommit = 0）需要在SQL执行后，执行commit执行提交事务

如果事务在执行过程中抛出异常，可以通过rollback指令回滚事务，实现对数据的恢复，保证数据的完整性和正确性

2.通过begin和commit主动开启事务和提交事务

```SQL
begin;//开启事务
---
SQL;
---
commit;//提交事务
//当出现异常时
rollback;//回滚事务
```

## 事务的四大特性

**原子性**：事务是不可分割的最小操作单元，要么全成功，要么全失败

**一致性**：事务完成时，必须使所有的数据都保持一致的状态

**隔离性**：数据库系统提供隔离机制，保证事务在不受外部并发操作影响的独立环境下运行

**持久性**：事务一旦提交或者回滚，它对数据库中的数据的改变就是永久的

## 并发事务问题

**脏读**：一个事务读取到另一个事务还没有提交的数据



**不可重复读**：一个事务先后读取同一条数据，但两次读取的数据不同（一个事务在另一个事务还未提交改之前select一次，在该事务提交后又select一次，两次结果不一致，所以不可重复读）同样的sql，在同一个事务中，查询结果不一致



**幻读**：一个事务按照条件查询数据时，没有对应的数据行，但是在插入数据时，又发现这行数据已经存在，好像出现了“幻影”

## 事务的隔离级别

|                         | 脏读 | 不可重复读 | 幻读 |
| ----------------------- | ---- | ---------- | ---- |
| Read uncommitted        | 1    | 1          | 1    |
| Read committed          | 0    | 1          | 1    |
| Repeatable Read（默认） | 0    | 0          | 1    |
| Serializable            | 0    | 0          | 0    |

查看事务隔离级别

```SQL
select @@transaction_isolation;//查看事务隔离级别
set session transaction isolation level read uncommitted;//设置事务隔离级别为可脏读
```

脏读：

![image-20250328220737818](C:\Users\Tibet\AppData\Roaming\Typora\typora-user-images\image-20250328220737818.png)

不可重复读：

![image-20250328222156510](C:\Users\Tibet\AppData\Roaming\Typora\typora-user-images\image-20250328222156510.png)

幻读：当前事务查询时，只有七条数据，id为8的数据没有，但是插入id=8时，却发现这行数据已经存在（其他事务插入了该条数据），出现了幻影。

![image-20250328224616247](C:\Users\Tibet\AppData\Roaming\Typora\typora-user-images\image-20250328224616247.png)
